```mermaid
flowchart LR

%% =========================
%% 1. Recording Plan BC（录像计划上下文）
%% =========================
subgraph RPLAN[Recording Plan BC]
    RPLAN_AR[RecordingPlan\n（聚合根）]
    RPLAN_RULE[RecordingScheduleRule\n（值对象）]
    RPLAN_STORE[StoragePolicy\n（值对象）]
end


%% =========================
%% 2. Device BC（设备上下文）
%% =========================
subgraph DEV[Device BC]
    DEV_AR[Device\n（聚合根）]
    DEV_STATUS[DeviceStatus\n（值对象）]
    DEV_SVC[DeviceConnectivityService\n（领域服务）]
end


%% =========================
%% 3. Inspection Plan BC（巡检计划上下文）
%% =========================
subgraph IPLAN[Inspection Plan BC]
    IPLAN_AR[InspectionPlan\n（聚合根）]
    IPLAN_DEVLIST[targetDevices\n（设备ID列表）]
    IPLAN_RULE[InspectionScheduleRule\n（值对象）]
    IPLAN_EVT[InspectionPlanTriggered]
end


%% =========================
%% 4. Recording BC（录像上下文）
%% =========================
subgraph REC[Recording BC]
    REC_SVC[RecordingFetchService\n（领域服务）]
    REC_SEG[RecordingSegment\n（值对象）]
    REC_CONT[RecordingContinuity\n（值对象）]
end


%% =========================
%% 5. Inspection Task BC（巡检任务上下文：执行模型）
%% =========================
subgraph TASK[Inspection Task BC]
    TASK_AR[InspectionTask\n（聚合根）]
    TASK_ITEM[InspectionItem\n（子实体: 每设备一项）]
    TASK_RES[InspectionResult\n（子实体/VO: 巡检项结果）]
    TASK_EVT1[InspectionTaskCreated]
    TASK_EVT_ITEM[InspectionItemCreated]
    TASK_EVT2[InspectionItemCompleted]
    TASK_EVT3[InspectionTaskCompleted]
end


%% =========================
%% 6. Reporting BC（巡检报告上下文：展示/查询模型）
%% =========================
subgraph REPORT[Reporting BC]
    REPORT_AR[InspectionReport\n（聚合根）]
    REPORT_ITEM[ReportItem\n（子实体: 每设备的展示结果）]
    REPORT_EVT[InspectionReportGenerated]
end


%% =========================
%% Cross-Context Interactions
%% =========================

%% Plan → Task
IPLAN_EVT --> TASK_EVT1
IPLAN_AR -->|按设备列表生成巡检项| TASK_EVT_ITEM --> TASK_ITEM

%% Task → Device（设备状态）
TASK_ITEM -->|查询设备状态| DEV_SVC
DEV_SVC --> DEV_STATUS --> TASK_ITEM

%% Task → Recording（获取录像片段）
TASK_ITEM -->|获取录像片段| REC_SVC
REC_SVC --> REC_SEG --> TASK_ITEM

%% Task → Recording（规则判定）
REC_SEG --> REC_CONT --> TASK_RES

%% Task 内部事件
TASK_EVT2 --> TASK_AR
TASK_AR --> TASK_EVT3

%% Task → Report
TASK_EVT3 --> REPORT_EVT --> REPORT_AR
REPORT_AR --> REPORT_ITEM

%% Report 展示关联设备/录像信息
REPORT_ITEM --> RPLAN_AR
REPORT_ITEM --> DEV_AR



```

# 录像巡检计划的生命周期状态图

```mermaid
stateDiagram-v2
    [*] --> Unconfigured

    Unconfigured --> Disabled : 首次配置巡检计划

    Disabled --> Enabled : 开启计划
    Enabled --> Disabled : 关闭计划

    Disabled --> Disabled : 编辑计划/手动触发
    Enabled --> Enabled : 编辑计划/定时触发/手动触发

```

# 录像巡检事件流

```mermaid
flowchart TD

%% ============================
%% Event Flow
%% ============================

subgraph TRIGGER[Trigger Source]
    AUTO[Auto Trigger\n（定时触发）]
    MANUAL[Manual Trigger\n（手动触发）]
end

subgraph TASK_FLOW[Task Flow]
    CREATED[InspectionTaskCreated\n任务创建]
    STARTED[InspectionTaskStarted\n任务开始]
end

subgraph DEVICE_CHECK[Device Checking Flow]
    CHECK1[InspectionDeviceChecked\n设备巡检结果1]
    CHECK2[InspectionDeviceChecked\n设备巡检结果2]
    CHECKN[InspectionDeviceChecked\n设备巡检结果N]
end

subgraph TASK_END[Task End]
    COMPLETED[InspectionTaskCompleted\n任务完成]
    FAILED[InspectionTaskFailed\n任务失败]
end

subgraph REPORT_FLOW[Report Flow]
    REPORT[InspectionReportGenerated\n巡检报告生成]
    NOTIFY[InspectionNotificationSent\n通知发送]
end

%% ============================
%% Flow Connections
%% ============================

AUTO --> CREATED
MANUAL --> CREATED

CREATED --> STARTED

STARTED --> CHECK1
CHECK1 --> CHECK2
CHECK2 --> CHECKN

CHECKN --> COMPLETED
CHECKN --> FAILED

COMPLETED --> REPORT
REPORT --> NOTIFY

FAILED -->|不会生成报告| TASK_END
```

## 事件相关测试点

2. InspectionTaskStarted —（任务开始执行事件）
到达调度执行时间后 ← 状态变为 Running
手动点击“立即巡检”后 ← 状态变为 Running
任务开始时间被填入
任务详情页显示“执行中”
能看到设备检查进度（n / total）

3. InspectionDeviceChecked —（单设备巡检完成事件）
每当一个设备巡检结束，任务状态更新
成功巡检 → 显示“正常”
异常巡检 → 显示“异常 + 原因”

4. InspectionTaskCompleted —（任务完成事件）

报告入口可点击，UI 上可查看完整任务结果

5. InspectionTaskFailed —（任务失败事件）
服务不可访问 → 任务进入 Failed
巡检计划找不到 → 任务直接 Failed

6. InspectionReportGenerated —（报告生成事件）
- 任务完成后，应生成完整报告

报告中包含：
全部设备巡检结果
正常数量、异常数量、正常率
无录像计划数量
设备分组、在线状态展示

- 任务为 Failed → 不应生成报告
- 任务只有部分设备结果 → 不生成报告

7. InspectionNotificationSent —（通知已发送事件）

若通知开关开启 → 在报告生成后发送通知
邮件模板正确替换参数（任务ID、正常率等）
SMS 模板正确替换参数
用户邮箱/短信收到通知

8. 手动触发录像巡检生效性验证；定时触发录像巡检生效性验证。

# 事件相关测试的抽象方法

事件维度的系统测试点来源于事件的三个要素：
“事件何时触发（When）——事件触发条件”
“事件携带什么信息（What）——事件输出/载荷”
“事件导致什么后果（Effect）——事件副作用/后续行为”

事件测试点 = Trigger × Payload × Effect × Non-occurrence（不发生）

- 满足触发条件时，事件是否发生
- 不满足触发条件时，事件是否不发生
- 事件携带的数据是否正确传播
- 事件流是否按因果关系发生
