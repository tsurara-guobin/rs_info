```mermaid
flowchart LR

%% =========================
%% 1. Recording Plan BCï¼ˆå½•åƒè®¡åˆ’ä¸Šä¸‹æ–‡ï¼‰
%% =========================
subgraph RPLAN[Recording Plan BC]
    RPLAN_AR[RecordingPlan\nï¼ˆèšåˆæ ¹ï¼‰]
    RPLAN_RULE[RecordingScheduleRule\nï¼ˆå€¼å¯¹è±¡ï¼‰]
    RPLAN_STORE[StoragePolicy\nï¼ˆå€¼å¯¹è±¡ï¼‰]
end


%% =========================
%% 2. Device BCï¼ˆè®¾å¤‡ä¸Šä¸‹æ–‡ï¼‰
%% =========================
subgraph DEV[Device BC]
    DEV_AR[Device\nï¼ˆèšåˆæ ¹ï¼‰]
    DEV_STATUS[DeviceStatus\nï¼ˆå€¼å¯¹è±¡ï¼‰]
    DEV_SVC[DeviceConnectivityService\nï¼ˆé¢†åŸŸæœåŠ¡ï¼‰]
end


%% =========================
%% 3. Inspection Plan BCï¼ˆå·¡æ£€è®¡åˆ’ä¸Šä¸‹æ–‡ï¼‰
%% =========================
subgraph IPLAN[Inspection Plan BC]
    IPLAN_AR[InspectionPlan\nï¼ˆèšåˆæ ¹ï¼‰]
    IPLAN_DEVLIST[targetDevices\nï¼ˆè®¾å¤‡IDåˆ—è¡¨ï¼‰]
    IPLAN_RULE[InspectionScheduleRule\nï¼ˆå€¼å¯¹è±¡ï¼‰]
    IPLAN_EVT[InspectionPlanTriggered]
end


%% =========================
%% 4. Recording BCï¼ˆå½•åƒä¸Šä¸‹æ–‡ï¼‰
%% =========================
subgraph REC[Recording BC]
    REC_SVC[RecordingFetchService\nï¼ˆé¢†åŸŸæœåŠ¡ï¼‰]
    REC_SEG[RecordingSegment\nï¼ˆå€¼å¯¹è±¡ï¼‰]
    REC_CONT[RecordingContinuity\nï¼ˆå€¼å¯¹è±¡ï¼‰]
end


%% =========================
%% 5. Inspection Task BCï¼ˆå·¡æ£€ä»»åŠ¡ä¸Šä¸‹æ–‡ï¼šæ‰§è¡Œæ¨¡å‹ï¼‰
%% =========================
subgraph TASK[Inspection Task BC]
    TASK_AR[InspectionTask\nï¼ˆèšåˆæ ¹ï¼‰]
    TASK_ITEM[InspectionItem\nï¼ˆå­å®ä½“: æ¯è®¾å¤‡ä¸€é¡¹ï¼‰]
    TASK_RES[InspectionResult\nï¼ˆå­å®ä½“/VO: å·¡æ£€é¡¹ç»“æœï¼‰]
    TASK_EVT1[InspectionTaskCreated]
    TASK_EVT_ITEM[InspectionItemCreated]
    TASK_EVT2[InspectionItemCompleted]
    TASK_EVT3[InspectionTaskCompleted]
end


%% =========================
%% 6. Reporting BCï¼ˆå·¡æ£€æŠ¥å‘Šä¸Šä¸‹æ–‡ï¼šå±•ç¤º/æŸ¥è¯¢æ¨¡å‹ï¼‰
%% =========================
subgraph REPORT[Reporting BC]
    REPORT_AR[InspectionReport\nï¼ˆèšåˆæ ¹ï¼‰]
    REPORT_ITEM[ReportItem\nï¼ˆå­å®ä½“: æ¯è®¾å¤‡çš„å±•ç¤ºç»“æœï¼‰]
    REPORT_EVT[InspectionReportGenerated]
end


%% =========================
%% Cross-Context Interactions
%% =========================

%% Plan â†’ Task
IPLAN_EVT --> TASK_EVT1
IPLAN_AR -->|æŒ‰è®¾å¤‡åˆ—è¡¨ç”Ÿæˆå·¡æ£€é¡¹| TASK_EVT_ITEM --> TASK_ITEM

%% Task â†’ Deviceï¼ˆè®¾å¤‡çŠ¶æ€ï¼‰
TASK_ITEM -->|æŸ¥è¯¢è®¾å¤‡çŠ¶æ€| DEV_SVC
DEV_SVC --> DEV_STATUS --> TASK_ITEM

%% Task â†’ Recordingï¼ˆè·å–å½•åƒç‰‡æ®µï¼‰
TASK_ITEM -->|è·å–å½•åƒç‰‡æ®µ| REC_SVC
REC_SVC --> REC_SEG --> TASK_ITEM

%% Task â†’ Recordingï¼ˆè§„åˆ™åˆ¤å®šï¼‰
REC_SEG --> REC_CONT --> TASK_RES

%% Task å†…éƒ¨äº‹ä»¶
TASK_EVT2 --> TASK_AR
TASK_AR --> TASK_EVT3

%% Task â†’ Report
TASK_EVT3 --> REPORT_EVT --> REPORT_AR
REPORT_AR --> REPORT_ITEM

%% Report å±•ç¤ºå…³è”è®¾å¤‡/å½•åƒä¿¡æ¯
REPORT_ITEM --> RPLAN_AR
REPORT_ITEM --> DEV_AR



```

# å½•åƒå·¡æ£€è®¡åˆ’çš„ç”Ÿå‘½å‘¨æœŸçŠ¶æ€å›¾

```mermaid
stateDiagram-v2
    [*] --> Unconfigured

    Unconfigured --> Disabled : é¦–æ¬¡é…ç½®å·¡æ£€è®¡åˆ’

    Disabled --> Enabled : å¼€å¯è®¡åˆ’
    Enabled --> Disabled : å…³é—­è®¡åˆ’

    Disabled --> Disabled : ç¼–è¾‘è®¡åˆ’/æ‰‹åŠ¨è§¦å‘
    Enabled --> Enabled : ç¼–è¾‘è®¡åˆ’/å®šæ—¶è§¦å‘/æ‰‹åŠ¨è§¦å‘

```

# å½•åƒå·¡æ£€äº‹ä»¶æµ

```mermaid
flowchart TD

%% ============================
%% Event Flow
%% ============================

subgraph TRIGGER[Trigger Source]
    AUTO[Auto Trigger\nï¼ˆå®šæ—¶è§¦å‘ï¼‰]
    MANUAL[Manual Trigger\nï¼ˆæ‰‹åŠ¨è§¦å‘ï¼‰]
end

subgraph TASK_FLOW[Task Flow]
    CREATED[InspectionTaskCreated\nä»»åŠ¡åˆ›å»º]
    STARTED[InspectionTaskStarted\nä»»åŠ¡å¼€å§‹]
end

subgraph DEVICE_CHECK[Device Checking Flow]
    CHECK1[InspectionDeviceChecked\nè®¾å¤‡å·¡æ£€ç»“æœ1]
    CHECK2[InspectionDeviceChecked\nè®¾å¤‡å·¡æ£€ç»“æœ2]
    CHECKN[InspectionDeviceChecked\nè®¾å¤‡å·¡æ£€ç»“æœN]
end

subgraph TASK_END[Task End]
    COMPLETED[InspectionTaskCompleted\nä»»åŠ¡å®Œæˆ]
    FAILED[InspectionTaskFailed\nä»»åŠ¡å¤±è´¥]
end

subgraph REPORT_FLOW[Report Flow]
    REPORT[InspectionReportGenerated\nå·¡æ£€æŠ¥å‘Šç”Ÿæˆ]
    NOTIFY[InspectionNotificationSent\né€šçŸ¥å‘é€]
end

%% ============================
%% Flow Connections
%% ============================

AUTO --> CREATED
MANUAL --> CREATED

CREATED --> STARTED

STARTED --> CHECK1
CHECK1 --> CHECK2
CHECK2 --> CHECKN

CHECKN --> COMPLETED
CHECKN --> FAILED

COMPLETED --> REPORT
REPORT --> NOTIFY

FAILED -->|ä¸ä¼šç”ŸæˆæŠ¥å‘Š| TASK_END
```

## äº‹ä»¶ç›¸å…³æµ‹è¯•ç‚¹

2. InspectionTaskStarted â€”ï¼ˆä»»åŠ¡å¼€å§‹æ‰§è¡Œäº‹ä»¶ï¼‰
åˆ°è¾¾è°ƒåº¦æ‰§è¡Œæ—¶é—´å â† çŠ¶æ€å˜ä¸º Running
æ‰‹åŠ¨ç‚¹å‡»â€œç«‹å³å·¡æ£€â€å â† çŠ¶æ€å˜ä¸º Running
ä»»åŠ¡å¼€å§‹æ—¶é—´è¢«å¡«å…¥
ä»»åŠ¡è¯¦æƒ…é¡µæ˜¾ç¤ºâ€œæ‰§è¡Œä¸­â€
èƒ½çœ‹åˆ°è®¾å¤‡æ£€æŸ¥è¿›åº¦ï¼ˆn / totalï¼‰

3. InspectionDeviceChecked â€”ï¼ˆå•è®¾å¤‡å·¡æ£€å®Œæˆäº‹ä»¶ï¼‰
æ¯å½“ä¸€ä¸ªè®¾å¤‡å·¡æ£€ç»“æŸï¼Œä»»åŠ¡çŠ¶æ€æ›´æ–°
æˆåŠŸå·¡æ£€ â†’ æ˜¾ç¤ºâ€œæ­£å¸¸â€
å¼‚å¸¸å·¡æ£€ â†’ æ˜¾ç¤ºâ€œå¼‚å¸¸ + åŸå› â€

4. InspectionTaskCompleted â€”ï¼ˆä»»åŠ¡å®Œæˆäº‹ä»¶ï¼‰

æŠ¥å‘Šå…¥å£å¯ç‚¹å‡»ï¼ŒUI ä¸Šå¯æŸ¥çœ‹å®Œæ•´ä»»åŠ¡ç»“æœ

5. InspectionTaskFailed â€”ï¼ˆä»»åŠ¡å¤±è´¥äº‹ä»¶ï¼‰
æœåŠ¡ä¸å¯è®¿é—® â†’ ä»»åŠ¡è¿›å…¥ Failed
å·¡æ£€è®¡åˆ’æ‰¾ä¸åˆ° â†’ ä»»åŠ¡ç›´æ¥ Failed

6. InspectionReportGenerated â€”ï¼ˆæŠ¥å‘Šç”Ÿæˆäº‹ä»¶ï¼‰
- ä»»åŠ¡å®Œæˆåï¼Œåº”ç”Ÿæˆå®Œæ•´æŠ¥å‘Š

æŠ¥å‘Šä¸­åŒ…å«ï¼š
å…¨éƒ¨è®¾å¤‡å·¡æ£€ç»“æœ
æ­£å¸¸æ•°é‡ã€å¼‚å¸¸æ•°é‡ã€æ­£å¸¸ç‡
æ— å½•åƒè®¡åˆ’æ•°é‡
è®¾å¤‡åˆ†ç»„ã€åœ¨çº¿çŠ¶æ€å±•ç¤º

- ä»»åŠ¡ä¸º Failed â†’ ä¸åº”ç”ŸæˆæŠ¥å‘Š
- ä»»åŠ¡åªæœ‰éƒ¨åˆ†è®¾å¤‡ç»“æœ â†’ ä¸ç”ŸæˆæŠ¥å‘Š

7. InspectionNotificationSent â€”ï¼ˆé€šçŸ¥å·²å‘é€äº‹ä»¶ï¼‰

è‹¥é€šçŸ¥å¼€å…³å¼€å¯ â†’ åœ¨æŠ¥å‘Šç”Ÿæˆåå‘é€é€šçŸ¥
é‚®ä»¶æ¨¡æ¿æ­£ç¡®æ›¿æ¢å‚æ•°ï¼ˆä»»åŠ¡IDã€æ­£å¸¸ç‡ç­‰ï¼‰
SMS æ¨¡æ¿æ­£ç¡®æ›¿æ¢å‚æ•°
ç”¨æˆ·é‚®ç®±/çŸ­ä¿¡æ”¶åˆ°é€šçŸ¥

8. æ‰‹åŠ¨è§¦å‘å½•åƒå·¡æ£€ç”Ÿæ•ˆæ€§éªŒè¯ï¼›å®šæ—¶è§¦å‘å½•åƒå·¡æ£€ç”Ÿæ•ˆæ€§éªŒè¯ã€‚

# äº‹ä»¶ç›¸å…³æµ‹è¯•çš„æŠ½è±¡æ–¹æ³•

äº‹ä»¶ç»´åº¦çš„ç³»ç»Ÿæµ‹è¯•ç‚¹æ¥æºäºäº‹ä»¶çš„ä¸‰ä¸ªè¦ç´ ï¼š
â€œäº‹ä»¶ä½•æ—¶è§¦å‘ï¼ˆWhenï¼‰â€”â€”äº‹ä»¶è§¦å‘æ¡ä»¶â€
â€œäº‹ä»¶æºå¸¦ä»€ä¹ˆä¿¡æ¯ï¼ˆWhatï¼‰â€”â€”äº‹ä»¶è¾“å‡º/è½½è·â€
â€œäº‹ä»¶å¯¼è‡´ä»€ä¹ˆåæœï¼ˆEffectï¼‰â€”â€”äº‹ä»¶å‰¯ä½œç”¨/åç»­è¡Œä¸ºâ€

äº‹ä»¶æµ‹è¯•ç‚¹ = Trigger Ã— Payload Ã— Effect Ã— Non-occurrenceï¼ˆä¸å‘ç”Ÿï¼‰

- æ»¡è¶³è§¦å‘æ¡ä»¶æ—¶ï¼Œäº‹ä»¶æ˜¯å¦å‘ç”Ÿ
- ä¸æ»¡è¶³è§¦å‘æ¡ä»¶æ—¶ï¼Œäº‹ä»¶æ˜¯å¦ä¸å‘ç”Ÿ
- äº‹ä»¶æºå¸¦çš„æ•°æ®æ˜¯å¦æ­£ç¡®ä¼ æ’­
- äº‹ä»¶æµæ˜¯å¦æŒ‰å› æœå…³ç³»å‘ç”Ÿ

# å½•åƒå·¡æ£€é¢†åŸŸæµç¨‹å›¾

```mermaid
flowchart TB

%% ======================
%% èšåˆå®šä¹‰
%% ======================

subgraph PLAN_AGG["ğŸ“¦ InspectionPlan èšåˆ"]
    Plan((InspectionPlan))
    Plan --åŒ…å«--> PlanDevices[è®¾å¤‡åˆ—è¡¨]
    Plan --åŒ…å«--> PlanSettings[å·¡æ£€å‘¨æœŸ/æ—¶é—´/é€šçŸ¥å¼€å…³/å­˜å‚¨é…ç½®]
end

subgraph DEVICE_AGG["ğŸ“¦ Device èšåˆ"]
    Device((Device))
    Device --åŒ…å«--> DeviceGroup[åˆ†ç»„]
    Device --åŒ…å«--> DeviceStatus[åœ¨çº¿çŠ¶æ€]
end

subgraph TASK_AGG["ğŸ“¦ Task èšåˆ"]
    Task((InspectionTask))
    Task --åŒ…å«--> TaskState[çŠ¶æ€ Pending/Running/Completed]
    Task --åŒ…å«--> TaskResult[Task-level Result Ref]
end

subgraph REPORT_AGG["ğŸ“¦ InspectionReport èšåˆ"]
    Report((InspectionReport))
    Report --åŒ…å«--> ReportHeader[è®¡åˆ’å/æ‰§è¡Œæ—¶é—´]
    Report --åŒ…å«--> ReportItems[æ¯è®¾å¤‡ç»“æœé¡¹åˆ—è¡¨]
    Report --åŒ…å«--> ReportStats[æ­£å¸¸/å¼‚å¸¸ç»Ÿè®¡]
end

%% ======================
%% å€¼å¯¹è±¡
%% ======================

subgraph VO["å€¼å¯¹è±¡ (Value Objects)"]
    IR[InspectionResult<br/>finalResult<br/>groupName<br/>onlineStatus<br/>hasPlan<br/>hasStorage<br/>hasRecordingYesterday]
    RF[RecordingFragment<br/>startTime/endTime]
end

%% ======================
%% é¢†åŸŸæœåŠ¡
%% ======================

subgraph DS["ğŸŸ§ é¢†åŸŸæœåŠ¡"]
    S1[InspectionTaskGenerationService<br/>ç”Ÿæˆä»»åŠ¡]
    S2[RecordingExistenceCheckingService<br/>åˆ¤æ–­å‰ä¸€å¤©æ˜¯å¦æœ‰å½•åƒ]
    S3[InspectionResultDeterminationService<br/>åˆ¤å®šæœ€ç»ˆå·¡æ£€ç»“æœ]
    S4[NotificationTriggerService<br/>åˆ¤æ–­æ˜¯å¦é€šçŸ¥]
    S5[NotificationContentBuilderService<br/>ç”Ÿæˆé€šçŸ¥å†…å®¹]
    S6[InspectionReportGenerationService<br/>ç”Ÿæˆå·¡æ£€æŠ¥å‘Š]
end

%% ======================
%% ä¸šåŠ¡æµç¨‹ç®­å¤´ï¼ˆå…³é”®ï¼‰
%% ======================

%% Step 1: Plan â†’ Task
Plan -->|æ‰§è¡Œåˆ°è®¡åˆ’| S1
S1 -->|ç”Ÿæˆå¤šä¸ªä»»åŠ¡| Task

%% Step 2: Taskæ‰§è¡Œ â†’ å½•åƒå­˜åœ¨æ€§åˆ¤æ–­
Task -->|å¯¹æ¯ä¸ªè®¾å¤‡æ‰§è¡Œ| S2
S2 -->|RF åˆ—è¡¨è¾“å…¥| IR

%% Step 3: ç»¼åˆåˆ¤å®š â†’ InspectionResult
Plan --> S3
Device --> S3
S2 --> S3
S3 -->|ç”Ÿæˆ InspectionResult| IR

%% Step 4: Report æ±‡æ€»
IR --> S6
Task --> S6
Plan --> S6
S6 --> Report

%% Step 5: æ˜¯å¦é€šçŸ¥
Plan --> S4
IR --> S4
S4 -->|true/false| S5

%% Step 6: é€šçŸ¥å†…å®¹ç”Ÿæˆ
IR --> S5
S5 -->|é€šçŸ¥æ–‡æœ¬| NotificationResult[(é€šçŸ¥å†…å®¹)]

%% ========================
%% è§†è§‰è¿çº¿ï¼ˆè¾…åŠ©è¯´æ˜ï¼‰
%% ========================

Device -.-> IR

%% Plan -.è§„åˆ™.-> IR


```
